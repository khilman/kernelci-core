{% extends 'boot/generic-uboot-tftp-ramdisk-boot-template.jinja2' %}
{% block metadata %}
{{ super() }}
{% endblock %}

{%- block main %}
{{ super() }}

protocols:
  lava-lxc:
    host:
      name: lxc-test
      template: debian
      distribution: debian
      release: jessie
      mirror: http://mirror.bytemark.co.uk/debian

  lava-multinode:
    roles:
       host:
         timeout:
           minutes: 15
         connection: lxc
         count: 1
         expect_role: host
         host_role: host
       target:
         device_type: {{ device_type }}
         count: 1
         timeout:
           minutes: 5 
         

actions:
- deploy:
    role:
    - host
    namespace: tlxc
    timeout:
      minutes: 5
    to: lxc
    

- boot:
    role:
    - host
    namespace: tlxc
    prompts:
    - 'root@(.*):/#'
    timeout:
      minutes: 5
    method: lxc
{%- endblock %}  

{% block actions %}   
{% block deploy %}
- deploy:
    role:
    - target 
    namespace: device
    timeout:
      minutes: 2
    to: tftp
    kernel:
      url: {{ kernel_url }}
{%- block kernel_image_type %}
      type: {{ kernel_image.lower() }}
{%- endblock %}      
{%- if initrd_url %}
    ramdisk: 
      url: {{ initrd_url }}
      compression: gz
{% endif %}
{%- if nfsrootfs_url %}
    nfsrootfs:
      url: {{ nfsrootfs_url }}
      compression: xz
{% endif %}
{%- if modules_url %}
    modules:
      url: {{ modules_url }}
      compression: xz
{% endif %}
{%- if dtb_url %}
    dtb: 
      url: {{ dtb_url }}
{% endif %}
    os: oe
{% endblock %}    

- boot:
    role:
    - target
    namespace: device
    timeout:
      minutes: 5
    method: u-boot
    commands: nfs
    prompts:
      - '{{ rootfs_prompt }}'


{% include 'multinode_measurements/target_test.jinja2' %}



- test:
    role:
    - host
    namespace: tlxc
    timeout:
      minutes: 5
    definitions:
    - repository: https://github.com/EmnaTrabelsi/testpower.git
      from: git
      name: host
      path: execs/power.yaml
{% endblock %}  



